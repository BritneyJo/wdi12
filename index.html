<!doctype html>
<html>
<head>
  <link rel="stylesheet" type="text/css" href="styles.css">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.min.js"></script>
</head>

<body>
<script type='text/x-handlebars-template' id='app'>
  {{#each weeks}}
    <div class='week'>
      <h1>Week {{this._index}}</h1>
      {{#each this}}
	<div class='day' id={{this.yyyymmdd}}>
	  <h2 class='day-header'><a href='#{{this.yyyymmdd}}'>{{this.date}}</a></h2>
	  {{#each this.day}}
	    <div>
	      {{#if this.url}}
		<h2 ><a style='color:{{this.color}}' href='{{this.url}}'>{{this.title}}</a></h2>
	      {{else}}
		<h2 style='color:{{this.color}}'>{{this.title}}</h2>
	      {{/if}}
	      <time>{{this.time}}</time>
	      <ul>
	        {{#if this.urls}}
		  {{#each this.urls}}
		    <li><a href='{{this.href}}'>{{this.title}}</a></li>
		  {{/each}}
		{{/if}}
	      </ul>
	      <ul>
	        {{#if this.lead}}
		  <li>{{this.lead}}</li>
		{{/if}}
	        {{#if this.support}}
		  <li>{{this.support}}</li>
		{{/if}}
	      </ul>
	    </div>
	  {{/each}}
	</div> 
      {{/each}}
    </div>
  {{/each}}
</script>
<div class='events' />
<script src='js-yaml.min.js'></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment.min.js"></script>
<script type='text/javascript'>
var request = new XMLHttpRequest();
request.open('GET', '/wdi12/schedule.yml', true);

var context = []
request.onload = function() {
  if (this.status >= 200 && this.status < 400) {
    var doc = jsyaml.load(this.response)
    var oi = 0
    var week = []
    for(var i = 0; i < doc[1].days.length; i++){
      if( i % 5 === 0 && i !== 0 ){
	week._index = context.length + 1
	context.push(week)
        week = []
        oi += 2
      }
      var day = doc[1].days[i]
      day.date = moment(doc[0]["start-date"]).add(oi,"days").format("ddd, MMM Do 'YY")
      day.yyyymmdd = moment(doc[0]["start-date"]).add(oi,"days").format("YYYY-MM-DD")
      day.day = day.day.map( event => {
        var time = Object.keys(event)[0]
	if(typeof event[time].url === "string"){
	  var url = event[time].url
	}
	if(typeof event[time].url === "object"){
	  var urls = event[time].url.map( e => {
	    var title = Object.keys(e)[0]
	    return {
	      title: title,
	      href: e[title]
	    }
	  })
	}
	var newDay = {
	  time: time,
	  url: url,
	  urls: urls
	}
	delete event[time].url
	for(var k in event[time]){
	  newDay[k] = event[time][k]
	}
	return newDay
      })
      week.push(day)
      oi++
    }
    var tpl = app.innerHTML
    var template = Handlebars.compile(tpl)
    var html = template({weeks:context})
    document.querySelector(".events").innerHTML = html
    if(window.location.hash){
      goTo(window.location.hash)
    }
  }
};
request.send();
onhashchange = function(e){
  goTo(location.hash)
}
function goTo(hash){
  var id = hash.substr(1)
  var target = document.getElementById(id)
  try{ document.querySelector(".target").classList.remove("target") } catch(e) {}
  target.classList.add("target")
  target.scrollIntoView()
}
</script>
</body>
</html>